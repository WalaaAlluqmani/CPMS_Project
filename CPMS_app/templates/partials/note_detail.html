<div class="max-w-3xl mx-auto">

  <!-- Breadcrumbs -->
  <div class="text-gray-600 text-sm mt-2 mb-4">
    <a href="/dashboard" class="hover:underline text-gray-600">لوحة التحكم</a> &gt;
    <a href="/notes" class="hover:underline text-gray-600">الملاحظات</a> &gt;
    <span>تفاصيل الملاحظة</span>
  </div>

  <div class="h-px bg-gray-100 w-1/2 mt-2 mb-4"></div>

  <!-- Note Card -->
  <div class="bg-white p-4 rounded-lg shadow w-full space-y-2">

    <!-- Meta (Header) -->
    <div class="space-y-2">

      <!-- Title + Date -->
      <div class="flex justify-between items-center">
        <h2 class="font-semibold text-lg text-gray-800">
          {{ note.title }}
        </h2>
        <span class="text-xs text-gray-400 whitespace-nowrap">
          {{ note.created_at|date:"Y/m/d، g:i a" }}
        </span>
      </div>

      <!-- From / To -->
      <div class="flex justify-between text-sm text-gray-600">
        <div>
          <span class="text-gray-500">من:</span>
          {% if note.sender == request.user %}
          انت
          {% else %}
          {{ note.sender.get_full_name }}
          {% endif %}
        </div>

        <div>
          <span class="text-gray-500">إلى:</span>
          {% if note.initiative %}
          {{ note.initiative.title }}
          {% elif note.department %}
          {{ note.department.name }}
          {% else %}
          {% if note.receiver == request.user %}
          انت
          {% else %}
          {{ note.receiver.get_full_name }}
          {% endif %}
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Divider -->
    <hr class="border-t border-gray-200" />

    <!-- Content -->
    <div class="text-gray-800 leading-relaxed px-1 pt-2">
      {{ note.content }}
    </div>

    {% if can_reply %}
    {% if grouped_replies %}

    <!-- Divider -->
    <div class="flex items-center justify-center gap-3 my-4 pt-2">
      <span class="h-px w-1/3 bg-gray-200"></span>
      <span class="text-xs text-gray-500 font-semibold">الردود</span>
      <span class="h-px w-1/3 bg-gray-200"></span>
    </div>


    <div class="space-y-3 max-h-[60vh] overflow-y-auto">

      {% for group in grouped_replies %}
      <div class="text-center text-xs text-gray-400 mb-2">
        {{ group.date|date:"Y/m/d" }}
      </div>

      {% for reply in group.notes %}
      <div class="chat {% if reply.sender == request.user %}chat-end{% else %}chat-start{% endif %}">
        <div class="chat-header text-xs font-semibold text-gray-500 mb-1">
          {{ reply.sender.get_full_name }}
        </div>

        <div class="chat-bubble relative
                     {% if reply.sender == request.user %}
                       bg-[#698274]/40 text-gray-800
                     {% else %}
                       bg-gray-100 text-gray-800
                     {% endif %}">
          {{ reply.content }}

          <time class="block mt-1 text-[10px] text-gray-500 text-left">
            {{ reply.created_at|date:"g:i a" }}
          </time>
        </div>

        <div class="chat-footer text-xs text-gray-400 mt-1">

          {% if request.user == reply.sender %}

          {% if note.receiver %}

          {% if is_read_by_receiver %}
          مقروءة
          {% else %}
          تم الإرسال
          {% endif %}

          {% endif %}

          {% endif %}

        </div>

      </div>
      {% endfor %}

      {% endfor %}

    </div>
    {% else %}
    <!-- Divider -->
    <div class="w-1/2 h-px bg-gray-200 mx-auto mt-4 mb-4"></div>
    <p class="text-gray-400 text-center py-4">لا يوجد ردود حتى الآن</p>
    {% endif %}
    {% endif %}


    <!-- Reply Box -->
 {% if can_reply %}
<form method="post" action="{% url 'note_detail' note.pk %}" class="flex items-center gap-2 mt-4 px-2">
  {% csrf_token %}
  <input type="hidden" name="action" value="reply" />

  <div class="flex items-center w-full rounded-full border border-gray-200 overflow-hidden bg-white">
    <textarea
      id="reply-text"
      name="reply_content"
      rows="1"
      placeholder="اكتب ردك هنا..."
      class="w-full resize-none px-4 py-2 text-sm outline-none bg-transparent"
      oninput="toggleSendButton(this)"
    ></textarea>

    <!-- Send Button -->
    <button id="send-btn" type="submit"
      class="p-2 rounded-full text-gray-400 transition-all duration-200"
      disabled>
      <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd"
          d="M10.293 2.293a1 1 0 011.414 0l6 6a1 1 0 01-1.414 1.414L12 5.414V17a1 1 0 11-2 0V5.414L4.707 9.707A1 1 0 013.293 8.293l6-6z"
          clip-rule="evenodd" />
      </svg>
    </button>
  </div>
</form>
{% endif %}

  </div>
</div>

<script>
  function toggleSendButton(el) {
    const btn = document.getElementById('send-btn');

    if (el.value.trim().length > 0) {
      btn.disabled = false;
      btn.classList.remove('text-gray-400');
      btn.classList.add('bg-[#00A399]', 'text-white', 'shadow-md');
    } else {
      btn.disabled = true;
      btn.classList.remove('bg-[#00A399]', 'text-white', 'shadow-md');
      btn.classList.add('text-gray-400');
    }
  }
</script>
